<script>
//nkGestures Mouse Gesture for Chrome 
//Copyright (C) 2009  CJvoid, Niklen, BugVuln
// 
//This program is free software: you can redistribute it and/or modify
//it under the terms of the GNU General Public License as published by
//the Free Software Foundation, either version 3 of the License, or
//(at your option) any later version.
// 
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
// 
//You should have received a copy of the GNU General Public License
//along with this program.  If not, see <http://www.gnu.org/licenses/>.

//toolstrip by nk
//nkToolStrip object 处理每个网页发送来的消息包括config.html的消息
var nkToolStrip = {
    gesturesName : "GesturesArray",
    
    open_drag_name : "isOpenDrag",
    
    searchWebName : "SearchEngine",
    
    searchWeb : "http://www.google.cn/search?q=",
    
    open_to_right : false,
    
    open_drag : false,
    
    actionsConfig : new Array(
    //newtab	        : 
    "DU",
    //close           : 
    "DR",
    //goback	        : 
    "L",
    //goforward		: 
    "R",
    //stop		    : 
    "D",
    //reload	        : 
    "UD",
    //refresh         : 
    "RD",
    //righttab	    : 
    "UR",
    //lefttab	        : 
    "UL",
    //firsttab	    : 
    "LU",
    //lasttab	        : 
    "RU"
    ),
   
    getCookie : function(c_name)
    {
        if (document.cookie.length>0)
        {
            c_start=document.cookie.indexOf(c_name + "=");
            if (c_start!=-1)
            { 
                c_start=c_start + c_name.length+1 ;
                c_end=document.cookie.indexOf(";",c_start);
                if (c_end==-1) c_end=document.cookie.length;
                return unescape(document.cookie.substring(c_start,c_end));
            } 
        }
        return "";
    },
    
    setCookie : function(c_name,value,expiredays)
    {
        var exdate=new Date();
        exdate.setDate(exdate.getDate()+expiredays);
        document.cookie=c_name+ "=" +escape(value)+((expiredays==null) ? "" : "; expires="+exdate.toGMTString());
    },
    
    string2array : function(string,array) 
    {
        var i,j;
        j = 0;
        for(i=0;i<array.length;i++)
	    {
	        var temp = '';
	        while (j<string.length && string[j]!=',') {
	            temp += string[j];
	            j++;
	        }
	        j++;
	        array[i] = temp;
	    }
    },
    
    init : function () {
        if (this.getCookie ('open_to_right') == 'enable') this.open_to_right = true;
        
        if (this.getCookie (this.open_drag_name) == 'enable') this.open_drag = true;

        var gestures = this.getCookie(this.gesturesName);
        if (gestures) {
            this.actionsConfig = gestures;
        }else
        {
            this.setCookie(this.gesturesName,this.actionsConfig,365);
        }
        
        var searchWeb = this.getCookie(this.searchWebName);
        if (searchWeb) {
            this.searchWeb = searchWeb;
        }else
        {
            this.setCookie(this.searchWebName,this.searchWeb,365);
        }        
    },
    
    refreshCookie : function () {
        this.actionsConfig = this.getCookie(this.gesturesName);
        this.searchWeb = this.getCookie(this.searchWebName);
        if (this.getCookie ('open_to_right') == 'enable') this.open_to_right = true;
        else this.open_to_right = false;
        if (this.getCookie (this.open_drag_name) == 'enable') this.open_drag = true;
        else this.open_drag = false;
    }    
};

nkToolStrip.init();

chrome.extension.onConnect.addListener(
	function(port)
	{
	    if(port.name != "nkGestures")
	        return;
		port.onMessage.addListener(
			function(message)
			{
				chrome.windows.get(port.tab.windowId, 
					function(curWnd)
					{
						if(message[1])
						{
						    switch(message[0]) {
					        case "do:drag":
						        var link = message[1];
						        if (link.indexOf ('http://') < 0)
						        {
						            link = searchWeb + link;
						        }
						        if(nkToolStrip.open_to_right)
							        chrome.tabs.create({'windowId':curWnd.id, 'index':port.tab.index + 1, 'url':message[1], 'selected':true});
							    else
							        chrome.tabs.create({'windowId':curWnd.id, 'url':link, 'selected':true});							    
							    break;
                    	    case "do:show":
						        document.getElementById("dirs").innerHTML = message[1];	
						    default:
						        break;
						    }
						}

						switch(message)
						{
						case "do:newtab":
						    if(nkToolStrip.open_to_right)
							    chrome.tabs.create({'windowId':curWnd.id, 'index':port.tab.index + 1, 'url':'chrome://newtab/', 'selected':true});
							else
							    chrome.tabs.create({'windowId':curWnd.id, 'url':'chrome://newtab/', 'selected':true});							    
							break;
						case "do:close":
							chrome.tabs.remove(port.tab.id);
							break;
						case "do:righttab":
						case "do:lefttab":
						case "do:lasttab":
						case "do:firsttab":
							chrome.tabs.getAllInWindow(curWnd.id, function(tabs)
							{
								for(var i = 0; i < tabs.length; i++)
								{
									if (tabs[i].id === port.tab.id)
									{
										var newtab;
										switch(message)
										{
										case "do:righttab":
											newtab = tabs[i+1] || tabs[0]; 
											break;
										case "do:lefttab":
											newtab = tabs[i-1] || tabs[tabs.length-1]; 
											break;
										case "do:lasttab":
											newtab = tabs[tabs.length-1]; 
											break;
										case "do:firsttab":
											newtab = tabs[0]; 
											break;
										}
										if (newtab)
										{
											chrome.tabs.update(newtab.id, {selected:true});
											chrome.tabs.update(port.tab.id, {selected:false});
										}
										break;
									}
								}
							});
							break;
						case "do:getcookie":
						    nkToolStrip.refreshCookie();
						    break;										    
						default:							
							break;
						}
					}
				);
			}
		);
		//发送用户定义的手势到连接来的tabs
        var connection = chrome.tabs.connect(port.tab.id,"nkGesturesTab");
        connection.postMessage(nkToolStrip.actionsConfig);
        if ( nkToolStrip.open_drag == true ) {
            connection.postMessage("OpenDarg");
        }        
	}
);
</script>
<div onclick="window.open ('config.htm')" class="toolstrip-button">
  <img src="mouse.png"><span id="dirs">Ready</span>
</div>

